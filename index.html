<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mesh Story — Pill Layout</title>

<style>
@font-face{
  font-family:'MeshFont';
  src:url('fonts/MeshFont.ttf') format('truetype');
  font-display:swap;
}

html,body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:MeshFont, system-ui, -apple-system, BlinkMacSystemFont, Inter, Arial, sans-serif;
}

body{
  display:flex;
  justify-content:center;
  padding:20px;
}

.container{
  width:100%;
  max-width:420px;
}

h1{
  text-align:center;
  font-size:16px;
  margin-bottom:10px;
  opacity:.7;
}

select,input,button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
  border:none;
  font-size:14px;
}

button{
  background:#1db954;
  color:#fff;
  cursor:pointer;
}

.toggle{
  display:flex;
  gap:8px;
}
.toggle label{
  flex:1;
  background:#222;
  padding:8px;
  text-align:center;
  border-radius:6px;
  cursor:pointer;
}
.toggle input{ display:none; }
.toggle input:checked + label{
  background:#1db954;
}

canvas{
  width:100%;
  height:auto;
  background:#000;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">

<h1>Mesh Story — Pill Lock</h1>

<select id="showPicker" disabled>
  <option>Loading shows…</option>
</select>

<input type="file" id="uploadInput" accept="image/*">
<input type="text" id="guestInput" placeholder="Add Guest (optional)">

<div class="toggle">
  <input type="radio" id="fmtStory" name="fmt" value="story" checked>
  <label for="fmtStory">Story</label>

  <input type="radio" id="fmt45" name="fmt" value="feed">
  <label for="fmt45">4:5</label>
</div>

<button id="renderBtn" disabled>Render</button>
<button id="downloadBtn" disabled>Download</button>

<canvas id="c" width="1080" height="1920"></canvas>

</div>

<script>
/* ===========================
   CONSTANTS
=========================== */
const TEXT_NUDGE_Y = 66;

const STORY_POS = {
  x: 128,
  nowPlayingY: 1512,
  dateY: 1661
};

const FEED45_POS = {
  x: 128,
  nowPlayingY: 900,
  dateY: 1040
};

const DJ_LINE_OFFSET = 46;
const MAX_PILL_WIDTH = 1080 - 256;
const PILL_PADDING_X = 36;
const DATE_TIME_GAP = 16;

let shows = [];
let bgData = null;

/* ===========================
   LOAD SHOW DATA
=========================== */
async function loadShows(){
  const res = await fetch(
    'https://script.google.com/macros/s/AKfycbw3QgJtZXB48I0BUMpTE5Dlo2kqMReNuD4jbiEVBaB1z49bSgzEkAgixkjHxwTKRwY0/exec'
  );
  shows = await res.json();

  showPicker.innerHTML='<option disabled selected>Select a show</option>';
  shows.forEach((s,i)=>{
    const d=new Date(s.Date);
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=
      `${d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} — ${s['Now Playing']}`;
    showPicker.appendChild(opt);
  });
  showPicker.disabled=false;
}

/* ===========================
   EVENTS
=========================== */
uploadInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    bgData=ev.target.result;
    renderBtn.disabled=false;
  };
  r.readAsDataURL(f);
};

renderBtn.onclick=()=>{
  const fmt=document.querySelector('input[name="fmt"]:checked').value;
  if(fmt==='story') drawStory();
  else drawFeed45();
};

/* ===========================
   HELPERS
=========================== */
function to12h(time){
  const [h,m]=time.split(':').map(Number);
  const hr=((h+11)%12)+1;
  return `${hr}${m?':'+m.toString().padStart(2,'0'):''}${h>=12?'pm':'am'}`;
}

function drawVignette(ctx,w,h){
  const g=ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*.25,w/2,h/2,Math.max(w,h)*.8);
  g.addColorStop(0,'rgba(0,0,0,0)');
  g.addColorStop(1,'rgba(0,0,0,.6)');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,w,h);
}

function drawWhitePill(ctx,x,y,w,h){
  ctx.fillStyle='#fff';
  ctx.beginPath();
  ctx.roundRect(x,y,w,h,16);
  ctx.fill();
}

function shrinkFont(ctx,text,start,maxW){
  let s=start;
  while(s>18){
    ctx.font=`${s}px MeshFont`;
    if(ctx.measureText(text).width<=maxW) break;
    s--;
  }
  return s;
}

function drawOverlay(ctx,w,h,src){
  const img=new Image();
  img.src=src;
  img.onload=()=>ctx.drawImage(img,0,0,w,h);
}

function drawCover(ctx,img,cw,ch){
  const scale=Math.max(cw/img.naturalWidth,ch/img.naturalHeight);
  const sw=cw/scale;
  const sh=ch/scale;
  const sx=(img.naturalWidth-sw)/2;
  const sy=(img.naturalHeight-sh)/2;
  ctx.drawImage(img,sx,sy,sw,sh,0,0,cw,ch);
}

/* ===========================
   STORY (UNCHANGED LOGIC)
=========================== */
function drawStory(){
  c.width=1080; c.height=1920;
  const ctx=c.getContext('2d');
  const show=shows[showPicker.value];
  if(!show||!bgData) return;

  const bg=new Image();
  bg.src=bgData;
  bg.onload=()=>{
    drawCover(ctx,bg,1080,1920);
    drawVignette(ctx,1080,1920);
    renderPills(ctx,show,STORY_POS,TEXT_NUDGE_Y);
    drawOverlay(ctx,1080,1920,'meshoverlay.png');
    downloadBtn.disabled=false;
  };
}

/* ===========================
   4:5 FEED (CENTER CROP)
=========================== */
function drawFeed45(){
  c.width=1080; c.height=1350;
  const ctx=c.getContext('2d');
  const show=shows[showPicker.value];
  if(!show||!bgData) return;

  const bg=new Image();
  bg.src=bgData;
  bg.onload=()=>{
    drawCover(ctx,bg,1080,1350);
    drawVignette(ctx,1080,1350);
    renderPills(ctx,show,FEED45_POS,TEXT_NUDGE_Y);
    drawOverlay(ctx,1080,1350,'meshoverlay45.png');
    downloadBtn.disabled=false;
  };
}

/* ===========================
   SHARED PILL RENDER
=========================== */
function renderPills(ctx,show,POS,NUDGE){
  const guest=guestInput.value.trim();
  const title=show['Now Playing'];

  const same=show.DJ &&
    title.trim().toLowerCase()===show.DJ.trim().toLowerCase();

  let primary=title;
  let secondary='';

  if(same){
    if(guest) primary+=` + ${guest}`;
  }else{
    secondary=show.DJ+(guest?` + ${guest}`:'');
  }

  const dateStr=new Date(show.Date)
    .toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
  const [s,e]=show['A-B'].split('-');
  const timeStr=`${to12h(s)} → ${to12h(e)}`;

  ctx.font='64px MeshFont';
  let pw=ctx.measureText(primary).width;
  ctx.font='42px MeshFont';
  let sw=secondary?ctx.measureText(secondary).width:0;

  let w=Math.max(pw,sw)+(PILL_PADDING_X*2);
  let x=POS.x;
  let pSize=64,sSize=42;

  if(w>MAX_PILL_WIDTH){
    const max=MAX_PILL_WIDTH-(PILL_PADDING_X*2);
    pSize=shrinkFont(ctx,primary,64,max);
    sSize=shrinkFont(ctx,secondary,42,max);
    w=MAX_PILL_WIDTH;
    x=(1080-w)/2;
  }

  drawWhitePill(ctx,x,POS.nowPlayingY+NUDGE,w,secondary?140:92);

  ctx.fillStyle='#000';
  ctx.font=`${pSize}px MeshFont`;
  ctx.fillText(primary,x+PILL_PADDING_X,POS.nowPlayingY+NUDGE+18);

  if(secondary){
    ctx.globalAlpha=.75;
    ctx.font=`${sSize}px MeshFont`;
    ctx.fillText(secondary,x+PILL_PADDING_X,POS.nowPlayingY+NUDGE+86);
    ctx.globalAlpha=1;
  }

  const dy=same?(POS.dateY-DJ_LINE_OFFSET):POS.dateY;

  ctx.font='32px MeshFont';
  const dw=ctx.measureText(dateStr).width+40;
  const tw=ctx.measureText(timeStr).width+40;

  drawWhitePill(ctx,x,dy+NUDGE,dw,52);
  drawWhitePill(ctx,x+dw+DATE_TIME_GAP,dy+NUDGE,tw,52);

  ctx.fillStyle='#000';
  ctx.fillText(dateStr,x+20,dy+NUDGE+10);
  ctx.fillText(timeStr,x+dw+DATE_TIME_GAP+20,dy+NUDGE+10);

  ctx.fillStyle='rgba(255,255,255,.75)';
  ctx.font='26px MeshFont';
  ctx.fillText('meshradio.live',x,dy+NUDGE+70);
}

/* ===========================
   iOS-SAFE DOWNLOAD
=========================== */
downloadBtn.onclick=async()=>{
  const blob=await new Promise(r=>c.toBlob(r,'image/png',1));
  const file=new File([blob],'mesh_artwork.png',{type:'image/png'});

  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{
      await navigator.share({files:[file]});
      return;
    }catch(e){}
  }

  const url=URL.createObjectURL(blob);
  window.open(url,'_blank');
  setTimeout(()=>URL.revokeObjectURL(url),60000);
};

window.onload=loadShows;
</script>
</body>
</html>
